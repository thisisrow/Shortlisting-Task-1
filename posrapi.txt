const ACCESS_TOKEN = "IGAARyPjOfdWNBZAE1qQVZAzWTk1UWFPUkV4MlVkZAWwzcXduZAE81MldaNm9MOU5nQ0hKRFpHUXRvZA1UwN09PVkxJYUV2TEhsdUlXSnRKcnhadHpUenFhYnlhUDJtUmFzV1U5Y3k5YmQ4YS1RTVVEc1B0cHk4cXlNanpOelQxZAkwzQQZDZD";
const IG_USER_ID = "17841470351044288"; 


// Fetch posts with comments
app.get("/posts", async (req, res) => {
  try {
    const fields = "id,caption,media_type,media_url,permalink,timestamp";
    const url = `https://graph.instagram.com/${IG_USER_ID}/media?fields=${fields}&access_token=${ACCESS_TOKEN}`;
    const response = await axios.get(url);

    const posts = response.data.data;

    // Fetch comments for each post
    const postsWithComments = await Promise.all(
      posts.map(async (post) => {
        try {
          const commentsUrl = `https://graph.instagram.com/${post.id}/comments?fields=id,text,username,timestamp&access_token=${ACCESS_TOKEN}`;
          const commentsRes = await axios.get(commentsUrl);

          return {
            ...post,
            comments: commentsRes.data.data || [],
          };
        } catch {
          return { ...post, comments: [] }; // In case comments are restricted
        }
      })
    );

    res.json({
      success: true,
      data: postsWithComments,
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.response?.data || error.message,
    });
  }
});
